# Next.js app mounted at /myapp without stripping prefix

# Handle both /myapp and /myapp/ variants with regex (prevents redirect loops)
# This approach is more reliable than rewrite rules that can cause conflicts
location ~ ^/myapp/?$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /myapp;
  proxy_set_header ngrok-skip-browser-warning "true";
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $myapp_upstream myapp-app:2000;
  proxy_pass http://$myapp_upstream/myapp;
}

# Handle bare _next directory (prevent redirect loop)
location = /myapp/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /myapp;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $myapp_upstream myapp-app:2000;
  proxy_pass http://$myapp_upstream/myapp/_next;  # no trailing slash prevents redirects
}

# Next.js assets and HMR - handle specific files
location ~ ^/myapp/_next/(.+)$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /myapp;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $myapp_upstream myapp-app:2000;
  proxy_pass http://$myapp_upstream/myapp/_next/$1;
}

# Handle root-level asset requests that Next.js apps often reference
location /icons/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $myapp_upstream myapp-app:2000;
  proxy_pass http://$myapp_upstream/icons/;
}

# Handle other common root-level files
location ~ ^/((robots\.txt|sitemap\.xml|manifest\.json|site\.webmanifest|apple-touch-icon\.png|favicon\.(ico|png|svg)))$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $myapp_upstream myapp-app:2000;
  proxy_pass http://$myapp_upstream/$1;
}

# Pages, RSC, data routes - more specific paths
location ~ ^/myapp/.+ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /myapp;
  proxy_set_header ngrok-skip-browser-warning "true";
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $myapp_upstream myapp-app:2000;
  proxy_pass http://$myapp_upstream;  # no trailing slash preserves full path
}


