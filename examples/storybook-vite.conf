# Storybook (Vite) under a subpath (e.g., /sdk or /storybook)
# This example shows explicit routes needed when running Storybook 9 + Vite
# behind the proxy under a path prefix, including HMR, manager, addons,
# common assets, iframe/index, and WebSocket endpoints.

# Change this prefix to your desired mount point
# For documentation clarity we use /storybook here.

location = /storybook/ {
  proxy_http_version 1.1;
  proxy_set_header Host storybook-service:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Prefix /storybook;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $sb_upstream storybook-service:6006;
  proxy_pass http://$sb_upstream/;  # upstream root serves base index
}

# Critical root files used by the story preview
location = /storybook/iframe.html { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/iframe.html; }
location = /storybook/index.json  { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/index.json; }

# Storybook manager/addons/common assets (SB9)
location ^~ /sb-manager/       { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/sb-manager/; }
location ^~ /sb-addons/        { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/sb-addons/; }
location ^~ /sb-common-assets/ { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/sb-common-assets/; }

# Convenience exact manager files that some builds reference at root
location = /runtime.js               { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/sb-manager/runtime.js; }
location = /common-manager-bundle.js { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/sb-addons/common-manager-bundle.js; }
location = /globals-runtime.js       { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_pass http://$sb_upstream/sb-manager/globals-runtime.js; }

# Vite dev endpoints (HMR/client/module resolution). Some Vite setups require the
# original host to be presented. If 404/blocked, try Host localhost:6006.
location ^~ /@vite/ { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_set_header Host localhost:6006; proxy_pass http://$sb_upstream/@vite/; }
location ^~ /@id/   { resolver 127.0.0.11 ipv6=off; resolver_timeout 5s; set $sb_upstream storybook-service:6006; proxy_set_header Host localhost:6006; proxy_pass http://$sb_upstream/@id/; }
location ^~ /node_modules/ {
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $sb_upstream storybook-service:6006;
  proxy_set_header Host localhost:6006;
  proxy_pass http://$sb_upstream/node_modules/;
}

# WebSocket for HMR under subpath
location ^~ /storybook/storybook-server-channel {
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host storybook-service:6006;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $sb_upstream storybook-service:6006;
  proxy_pass http://$sb_upstream/storybook-server-channel;
}


