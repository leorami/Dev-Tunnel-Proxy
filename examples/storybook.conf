# Storybook Configuration
#
# This example shows how to configure Storybook for subpath deployment
# under a prefix like /storybook or /docs
#
# Storybook requirements:
# - STORYBOOK_BASE_PATH=/storybook in environment
# - .storybook/main.js configured with config.base setting
# - WebSocket/HMR configuration for proxy usage

location = /storybook {
    return 301 /storybook/;
}

location /storybook/ {
    # Standard proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /storybook;
    
    # WebSocket support for Storybook HMR
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Development helpers
    proxy_set_header ngrok-skip-browser-warning "true";
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    
    # CRITICAL: Use variables for upstream resolution
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $storybook_upstream storybook-service:6006;
    proxy_pass http://$storybook_upstream;  # no trailing slash preserves /storybook/
}

# Handle Storybook assets that may be requested at root level
# Common for Vite-based Storybook instances
location ^~ /src/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $storybook_upstream storybook-service:6006;
    proxy_pass http://$storybook_upstream/src/;
}

# Handle iframe requests for story rendering
location /storybook/iframe.html {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $storybook_upstream storybook-service:6006;
    proxy_pass http://$storybook_upstream/storybook/iframe.html;
}
