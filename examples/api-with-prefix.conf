# API Service Configuration (Prefix Preserved)
#
# This example shows how to configure an API service that expects
# requests to include the path prefix (e.g., /api)
#
# Use this when:
# - API service handles routing internally
# - Service expects /api/users, /api/health, etc.
# - Multiple APIs under different prefixes

location /api/ {
    # Standard proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /api;
    
    # API-specific headers
    proxy_set_header Accept application/json;
    proxy_set_header Content-Type application/json;
    
    # Development helpers
    proxy_set_header ngrok-skip-browser-warning "true";
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    
    # CRITICAL: Use variables for upstream resolution
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $api_upstream api-service:8000;
    proxy_pass http://$api_upstream;  # no trailing slash preserves /api/
}

# Optional: Health check endpoint
location = /api/health {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $api_upstream api-service:8000;
    proxy_pass http://$api_upstream/api/health;
}
