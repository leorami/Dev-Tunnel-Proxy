# ========= Encast (isolated) =========

# API â†’ Django (strip /api prefix)
location /api/ {
  rewrite ^/api/(.*)$ /$1 break;
  proxy_pass http://api:8000;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header ngrok-skip-browser-warning "true";
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# Impact (CRA dev server, HMR/WS)
location /impact/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_pass http://impact:3000;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# Inspire (CRA @ 3001)
location /inspire/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_pass http://inspire:3001;
}

# Canonical /sdk handler - Static Storybook
location ^~ /sdk/ {
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  
  # Strip /sdk and proxy to static server
  rewrite ^/sdk/(.*)$ /$1 break;
  proxy_pass http://encast-sdk:6006;
}

 

# Static Storybook doesn't need Vite dev routes

# Admin and payment
location /admin/   { proxy_pass http://api:8000/admin/;   proxy_set_header ngrok-skip-browser-warning "true"; }
location /payment/ { proxy_pass http://payment:5454/;     proxy_set_header ngrok-skip-browser-warning "true"; }
