# Lyra dev proxy config (generated)

# Handle both /lyra and /lyra/ via regex to avoid redirect loops
location ~ ^/lyra/?$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /lyra;
  proxy_set_header ngrok-skip-browser-warning "true";
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $lyra_upstream lyra-dev:4000;
  proxy_pass http://$lyra_upstream/lyra;  # no trailing slash
}

# Bare _next dir (avoid 308)
location = /lyra/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /lyra;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $lyra_upstream lyra-dev:4000;
  proxy_pass http://$lyra_upstream/lyra/_next;  # no trailing slash
}

# Specific _next files (assets + HMR)
location ~ ^/lyra/_next/(.+)$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /lyra;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $lyra_upstream lyra-dev:4000;
  proxy_pass http://$lyra_upstream/lyra/_next/$1;
}

# Pages and data routes
location ~ ^/lyra/.+ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /lyra;
  proxy_set_header ngrok-skip-browser-warning "true";
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $lyra_upstream lyra-dev:4000;
  proxy_pass http://$lyra_upstream;  # preserve full path
}
location = /_next { return 204; }
location = /_next/ { return 204; }
