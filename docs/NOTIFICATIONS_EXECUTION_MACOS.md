# Notifications Execution on macOS

The notifications UI stores rules per route (Conditions → Action → Message). This document describes how to **run the execution engine on macOS**, which is the only supported platform for sending texts right now.

## How it works

The macOS engine:

1. Reads rules from: `./.artifacts/route-notifications.json`
2. Reads route → upstream mapping from: `./.artifacts/reports/scan-apps-latest.json` (generated by the auto-scan process)
3. Uses Docker on your Mac to inspect the upstream container status (`running | paused | stopped`)
4. Checks whether the proxy is externally accessible by looking for a discovered ngrok URL
5. Sends texts using **Messages.app** via AppleScript

The engine fires **only on transitions** into a matching state, so it won’t spam you every poll.

## One-time prerequisites

1. **Docker Desktop** running
2. **Messages.app** is set up (iMessage and/or SMS relay)
3. Node.js installed (recommended: Node 18+)

macOS will prompt you to allow automation the first time the engine tries to control Messages.

## Run manually

From the repo root:

```bash
node macos/notifications-engine.js
```

Optional: change polling interval (seconds):

```bash
NOTIF_POLL_INTERVAL_SEC=5 node macos/notifications-engine.js
```

## Install as a background service (LaunchAgent)

### Option 1: From the UI (Recommended)

1. Start the notifications bridge:
   ```bash
   node macos/notifications-bridge.js
   ```

2. Open the Status UI and navigate to any route's Notifications panel

3. Look for the **⚙️ Background Service** section at the top

4. Click **Install Service** to install and start the background engine

The UI will show the service status and provide an **Uninstall Service** button when installed.

### Option 2: Command Line

```bash
chmod +x macos/install-notifications-engine.sh
./macos/install-notifications-engine.sh install
```

Logs land here:

- `./.artifacts/notifications-engine.log`
- `./.artifacts/notifications-engine.err`

Uninstall:

```bash
./macos/install-notifications-engine.sh uninstall
```

## Troubleshooting

### No messages are being sent

The engine only sends on a **transition** (e.g., `stopped → running`). Restart your upstream container to test.

### Messages automation permission issues

Go to:

**System Settings → Privacy & Security → Automation**

Then allow your terminal app (or the LaunchAgent parent) to control **Messages**.

### Route status is always `unknown`

Make sure the auto-scan report exists:

`./.artifacts/reports/scan-apps-latest.json`

That file provides the upstream mapping needed to connect a route to a container.
