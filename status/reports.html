<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dev Proxy Reports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/status/assets/favicon.svg" />
    <link rel="stylesheet" href="/status/global.css" />
    <style>
      body{margin:0}
      header{padding:16px 20px;border-bottom:1px solid var(--border);background:var(--headerBg);backdrop-filter:saturate(180%) blur(8px);position:sticky;top:0}
      .header-row{display:flex;align-items:center;justify-content:space-between}
      .container{max-width:1160px;margin:24px auto;padding:0 16px}
      .header-actions{display:flex;align-items:center;gap:8px}
      .header-actions .tab{background:#132a4d}
      .header-actions .tab.active{background:#d9e2ff;color:#0b1220;border-color:#bfd1ff}
      [data-theme="dark"] .header-actions .tab.active{background:#1a2a4b;color:#cfe0ff;border-color:#36568c}
      .header-actions .action{background:#0f2242;border-color:#2a4a7e}
      :root[data-theme="light"] .header-actions .action{background:#eef2ff;border-color:#bfd1ff;color:#0b1220}
      .header-actions .divider{display:inline-block;width:10px;height:28px;margin:0 6px;border-left:1px solid var(--border)}
      .toolbar{display:flex;gap:8px;flex-wrap:wrap}
      button, a.btn{appearance:none;border:1px solid var(--btnBorder);background:var(--btnBg);color:var(--btnText);border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:600;text-decoration:none}
      .grid{display:grid;grid-template-columns: 1fr;gap:12px}
      .card{background:var(--panelGlass);border:1px solid var(--border);border-radius:12px;padding:16px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
      th{color:var(--text)}
      .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);color:var(--text);font-weight:600}
    </style>
    <link rel="stylesheet" href="/status/common.css" />
    <script src="/status/common.js"></script>
  </head>
  <body>
    <script>window.DTP && DTP.attachHeader('reports'); window.DTP && DTP.attachCalliope && DTP.attachCalliope(); window.DTP && DTP.initTheme && DTP.initTheme();</script>
    <header style="display:none">
      <div class="header-row">
        <h1 style="font-size:16px;margin:0;display:flex;gap:10px;align-items:center">
          <img src="/status/assets/logo.svg" alt="Dev Tunnel Proxy logo" style="height:40px"/>
          <span class="tag">Dev Tunnel Proxy</span>
        </h1>
        <div class="header-actions"></div>
      </div>
    </header>
    <div class="container">
      <div class="card">
        <div class="toolbar" style="margin-bottom:12px">
          <button id="refresh">Refresh</button>
          <button id="prune7">Prune > 7 days</button>
          <button id="prune30">Prune > 30 days</button>
          <button id="pruneAllButLatest">Prune all but latest</button>
        </div>
        <table>
          <thead>
            <tr><th>Name</th><th>Kind</th><th>Size</th><th>Last Modified</th></tr>
          </thead>
          <tbody id="rows"><tr><td colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <script>
      async function api(path, opts){
        const r = await fetch(path, { headers:{'ngrok-skip-browser-warning':'true','content-type':'application/json'}, ...opts });
        if(!r.ok) throw new Error(await r.text());
        return r.json();
      }
      function fmtSize(n){ if(!n && n!==0) return '—'; const kb = n/1024; return kb<1024?`${kb.toFixed(1)} KB`:`${(kb/1024).toFixed(2)} MB`; }
      function kindOf(name){
        if (/health-.*\.json$/.test(name)) return 'health-json';
        if (/health-.*\.md$/.test(name)) return 'health-md';
        if (/scan-apps-.*\.json$/.test(name)) return 'scan-apps';
        if (/latest\./.test(name)) return 'alias';
        return name.split('.').pop();
      }
      async function load(){
        const data = await api('/api/reports/list');
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        data.items.forEach(it=>{
          const tr = document.createElement('tr');
          const link = `/reports/${encodeURIComponent(it.name)}`;
          tr.innerHTML = `<td><a href="${link}">${it.name}</a></td>`+
                         `<td>${kindOf(it.name)}</td>`+
                         `<td>${fmtSize(it.size)}</td>`+
                         `<td>${new Date(it.mtimeMs).toLocaleString()}</td>`;
          tbody.appendChild(tr);
        });
      }
      async function prune(days){
        await api('/api/reports/prune', { method:'POST', body: JSON.stringify({ olderThanDays: days }) });
        await load();
      }
      async function pruneAllButLatest(){
        await api('/api/reports/prune', { method:'POST', body: JSON.stringify({ keepLatestPerKind: true }) });
        await load();
      }
      document.getElementById('refresh').addEventListener('click', load);
      document.getElementById('prune7').addEventListener('click', ()=>prune(7));
      document.getElementById('prune30').addEventListener('click', ()=>prune(30));
      document.getElementById('pruneAllButLatest').addEventListener('click', pruneAllButLatest);
      // Align Directory button right over the table by moving it beside the actions
      try { document.getElementById('directoryBtn').style.marginLeft = 'auto'; } catch {}
      // Use shared Calliope + theme
      try{ if (window.DTP && DTP.attachCalliope) DTP.attachCalliope(); }catch{}
      try{ if (window.DTP && DTP.initTheme) DTP.initTheme(); }catch{}
      load();
    </script>
  </body>
</html>


