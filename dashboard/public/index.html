<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dev Tunnel Dashboard</title>
    <link rel="stylesheet" href="/status/global.css" />
    <link rel="stylesheet" href="/status/common.css" />
    <script src="/status/common.js"></script>
    <style>
      *{box-sizing:border-box}
      body{line-height:1.5;margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text)}
      main{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:18px}
      body.ai-open[data-page="dashboard"] main{padding-right:0 !important;margin-right:calc(var(--aiWidth) + var(--aiGutter))}
      .card{background:var(--panelGlass);border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.25);backdrop-filter:saturate(160%) blur(6px)}
      .card h3{font-size:14px;margin:0 0 8px 0;color:var(--heading)}
      .side{padding:14px}
      .row{display:flex;gap:8px;align-items:center;margin:10px 0}
      input[type=text]{flex:1;min-width:280px;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text)}
      button{padding:8px 10px;border:1px solid var(--btnBorder);border-radius:8px;background:var(--btnBg);color:var(--btnText);cursor:pointer;font-weight:600}
      button:hover{background:var(--btnBgHover)}
      .accent{background:var(--accent);color:#0a1116;border-color:transparent}
      .routes{display:flex;flex-direction:column;gap:6px;margin-top:8px}
      .route{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--panel)}
      .route small{color:var(--muted)}
      .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px}
      .content{padding:14px}
      pre{white-space:pre-wrap;background:var(--codeBg);border:1px solid var(--codeBorder);padding:12px;border-radius:10px;max-width:100%}
      .log{max-height:360px;overflow:auto}
    </style>
  </head>
  <body>
    <script>window.DTP && DTP.attachHeader('dashboard'); window.DTP && DTP.attachCalliope && DTP.attachCalliope(); window.DTP && DTP.initTheme && DTP.initTheme();</script>
    <header style="display:none">
      <h1>Dev Tunnel Dashboard â€¢ Calliope Tools</h1>
      <div class="row"><button id="btnThoughts">Updates</button></div>
    </header>
    <main class="content" style="max-width:1160px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:320px 1fr;gap:16px;">
      <section class="card side" style="padding:14px">
        <h3>Quick Audit</h3>
        <div class="row"><input id="auditUrl" type="text" placeholder="https://your-ngrok-domain/mxtk" /></div>
        <div class="row">
          <button id="btnAudit" class="accent">Run Audit</button>
          <button id="btnAuditHeal">Audit + Heal</button>
          <button id="btnHeal">Advanced Heal</button>
        </div>
        <h3 style="margin-top:16px">Routes</h3>
        <div id="routes" class="routes"></div>
      </section>
      <section class="card content" style="padding:14px">
        <h3>Result</h3>
        <pre id="out" class="log">No output yet.</pre>
      </section>
    </main>
    <script>
      async function post(url, body){
        const r = await fetch(url,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body||{})});
        return await r.json();
      }
      const out = document.getElementById('out');
      document.getElementById('btnAudit').onclick = async ()=>{
        const url = document.getElementById('auditUrl').value.trim();
        out.textContent = 'Running audit...';
        const res = await post('/proxy/ai/audit',{ url, wait:2000, timeout:30000 });
        out.textContent = JSON.stringify(res,null,2);
      };
      document.getElementById('btnHeal').onclick = async ()=>{
        const url = document.getElementById('auditUrl').value.trim();
        out.textContent = 'Starting advanced heal...';
        const res = await post('/proxy/ai/advanced-heal',{ route: new URL(url).pathname.split('/')[1] ? `/${new URL(url).pathname.split('/')[1]}` : '' });
        out.textContent = JSON.stringify(res,null,2);
      };
      document.getElementById('btnAuditHeal').onclick = async ()=>{
        const url = document.getElementById('auditUrl').value.trim();
        if (!url) { out.textContent = 'Enter URL first'; return; }
        out.textContent = 'Audit + Heal running...';
        const route = new URL(url).pathname.split('/')[1] ? `/${new URL(url).pathname.split('/')[1]}` : '/';
        const res = await post('/proxy/ai/audit-and-heal',{ url, route, wait:2000, timeout:60000, maxPasses:4 });
        out.textContent = JSON.stringify(res,null,2);
      };
      document.getElementById('btnThoughts').onclick = async ()=>{
        const r = await fetch('/proxy/ai/thoughts');
        const j = await r.json();
        out.textContent = JSON.stringify(j,null,2);
      };

      // Load routes and render per-route audit/heal buttons
      async function loadRoutes(){
        try{
          const r = await fetch('/routes');
          const j = await r.json();
          const keys = Object.keys(j.metadata||{});
          const container = document.getElementById('routes');
          container.innerHTML = '';
          keys.slice(0,100).forEach(k => {
            const div = document.createElement('div');
            div.className = 'route';
            const left = document.createElement('div');
            left.innerHTML = `<span class="pill">route</span> <small>${k}</small>`;
            const right = document.createElement('div');
            const btnA = document.createElement('button');
            btnA.textContent = 'Audit';
            btnA.onclick = async ()=>{
              const base = document.getElementById('auditUrl').value.trim();
              if (!base) { out.textContent = 'Enter base URL above (e.g., https://.../mxtk)'; return; }
              // Build absolute URL: base origin + route key
              const u0 = new URL(base);
              const abs = `${u0.origin}${k}`;
              out.textContent = `Auditing ${abs} ...`;
              const res = await post('/proxy/ai/audit',{ url: abs, wait:2000 });
              out.textContent = JSON.stringify(res,null,2);
            };
            const btnH = document.createElement('button');
            btnH.textContent = 'Heal';
            btnH.onclick = async ()=>{
              out.textContent = `Healing ${k} ...`;
              const res = await post('/proxy/ai/advanced-heal',{ route: k.replace(/\/$/,'') });
              out.textContent = JSON.stringify(res,null,2);
            };
            const btnAH = document.createElement('button');
            btnAH.textContent = 'Audit+Heal';
            btnAH.onclick = async ()=>{
              const base = document.getElementById('auditUrl').value.trim();
              if (!base) { out.textContent = 'Enter base URL above (e.g., https://.../mxtk)'; return; }
              const u0 = new URL(base);
              const abs = `${u0.origin}${k}`;
              out.textContent = `Audit+Heal ${abs} ...`;
              const res = await post('/proxy/ai/audit-and-heal',{ url: abs, route: k.replace(/\/$/,'') });
              out.textContent = JSON.stringify(res,null,2);
            };
            right.appendChild(btnA); right.appendChild(btnH); right.appendChild(btnAH);
            div.appendChild(left); div.appendChild(right);
            container.appendChild(div);
          });
        }catch(e){
          console.error(e);
        }
      }
      loadRoutes();
    </script>
  </body>
  </html>


