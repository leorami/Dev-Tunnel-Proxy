server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;

  # Redirect root to status page
  location = / {
    return 302 /status;
  }

  # Machine health (JSON)
  location = /health.json {
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"dev-tunnel-proxy"}';
  }

  # Human health (HTML dashboard)
  location = /health {
    try_files /status/health.html =404;
  }
  # Handle trailing slash
  location = /health/ { return 302 /health; }

  # Status JSON (latest health report)
  location = /status.json {
    types { application/json json; }
    try_files /.artifacts/reports/health-latest.json =404;
  }

  # Status HTML (simple viewer)
  location = /status {
    try_files /status/status.html =404;
  }
  # Ensure /status/* assets are served regardless of app regex blocks
  location ^~ /status/ {
    try_files $uri /status/status.html =404;
  }
  # Serve root logo asset for branding
  location = /dev-tunnel-proxy.svg {
    try_files /dev-tunnel-proxy.svg =404;
  }
  # Handle trailing slash
  location = /status/ { return 302 /status; }

  # Ngrok JSON (expose from health-latest for convenience)
  location = /ngrok.json {
    types { application/json json; }
    try_files /.artifacts/reports/health-latest.json =404;
  }

  # Routes JSON (latest scan)
  location = /routes.json {
    types { application/json json; }
    try_files /.artifacts/reports/scan-apps-latest.json =404;
  }

  # Browse reports
  location ^~ /reports/ {
    alias /usr/share/nginx/html/.artifacts/reports/;
    autoindex on;
  }

  # App routes
  include /etc/nginx/conf.d/apps/*.conf;
}