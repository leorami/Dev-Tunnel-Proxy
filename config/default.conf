# Suppress noisy access logs for dev-helper paths to reduce container chattiness
map $request_uri $loggable {
  default 1;
  ~^/(sdk/)?(@vite/|@id/|@fs/|node_modules/|sb-manager/|sb-addons/|sb-common-assets/|storybook-server-channel) 0;
  ~^/(_next/|mxtk/_next/) 0;
}

upstream storybook_sdk {
  server sdk:6006;
  keepalive 32;
}

server {
  listen 80;
  listen 443 ssl;
  ssl_certificate /etc/nginx/certs/dev.crt;
  ssl_certificate_key /etc/nginx/certs/dev.key;
  server_name _;
  root /usr/share/nginx/html;

  # Only log access for non-dev-helper paths
  access_log /var/log/nginx/access.log combined if=$loggable;
  error_log /var/log/nginx/error.log warn;

  # Global upstream var for runtime DNS resolution used by overrides
  set $up_encast_sdk encast-sdk:6006;

  # Redirect root to status page
  location = / {
    return 302 /status;
  }

  location = /favicon.ico {
    try_files /status/assets/favicon.png /status/favicon.png =404;
  }

  # Machine health (JSON)
  location = /health.json {
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"dev-tunnel-proxy"}';
  }

  # Human health (HTML dashboard)
  location = /health {
    try_files /status/health.html =404;
  }
  # Handle trailing slash
  location = /health/ { return 302 /health; }

  # Status JSON (latest health report)
  location = /status.json {
    types { application/json json; }
    try_files /.artifacts/reports/health-latest.json =404;
  }

  # Status HTML (simple viewer)
  location = /status {
    try_files /status/status.html =404;
  }
  # Ensure /status/* assets are served regardless of app regex blocks
  location ^~ /status/ {
    try_files $uri /status/status.html =404;
  }
  # Serve root logo asset for branding
  location = /dev-tunnel-proxy.svg {
    try_files /dev-tunnel-proxy.svg =404;
  }
  # Handle trailing slash
  location = /status/ { return 302 /status; }

  # Proxy JSON (expose from health-latest for convenience)
  location = /ngrok.json {
    types { application/json json; }
    try_files /.artifacts/reports/health-latest.json =404;
  }

  # Dashboard (route-focused tools) - static served by nginx from /usr/share/nginx/html/dashboard
  location = /dashboard { return 302 /dashboard/; }
  location ^~ /dashboard/ {
    try_files $uri /dashboard/index.html =404;
    add_header Cache-Control "no-store" always;
  }
  # Dashboard expects /routes; map it to routes.json
  location = /routes {
    types { application/json json; }
    try_files /.artifacts/reports/scan-apps-latest.json =404;
  }

  # Routes JSON (latest scan)
  location = /routes.json {
    types { application/json json; }
    try_files /.artifacts/reports/scan-apps-latest.json =404;
  }

  # Storybook absolute paths (safety net at server level)
  # These blocks will only be used if there's no matching location in the app configs
  # If you change these, also update the autofix in utils/proxyConfigAPI.js (self-heal)
  location = /iframe.html {
    proxy_set_header Host $host;
    proxy_pass http://storybook_sdk/iframe.html;
  }
  location = /sdk/iframe.html {
    proxy_set_header Host $host;
    proxy_pass http://storybook_sdk/iframe.html;
  }

  # Browse reports
  # Pretty UI at /reports, raw directory at /reports/
  location = /reports { try_files /status/reports.html =404; }
  location ^~ /reports/ {
    alias /usr/share/nginx/html/.artifacts/reports/;
    autoindex on;
  }

  # Proxy Configuration API (proxy to Node.js service)
  # Install new app config
  location = /api/apps/install {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Apps management: list, diagnostics, active, regenerate, cleanup, scan
  location ^~ /api/apps/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ^~ /api/config/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /api/resolve-conflict {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /api/rename-route {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Overrides configuration management (list conflicts, promote app config into overrides)
  location ^~ /api/overrides/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Reports management API (list/prune artifacts)
  location ^~ /api/reports/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # AI assistant endpoints (optional; proxied to Node API)

  location ^~ /api/ai/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  # Dashboard static app proxies to AI via /proxy/ai/*
  location ^~ /proxy/ai/ {
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;
    set $cfg http://proxy-config-api:3001;
    proxy_pass $cfg/api/ai/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Generated app routes (proxy-owned precedence)
  include /etc/nginx/conf.d/sites-enabled/*.conf;
}