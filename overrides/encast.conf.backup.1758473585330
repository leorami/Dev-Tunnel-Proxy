# Overrides for Storybook + Vite under /sdk and root dev helpers
# These blocks forward requests to encast-sdk:6006 and are idempotent

# SDK Storybook base route (strip /sdk/ prefix) with HMR
location = /sdk { rewrite ^ /sdk/ last; }
location ^~ /sdk/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Accept-Encoding "";
  sub_filter_types text/html application/javascript text/javascript application/json;
  sub_filter_once off;
  sub_filter '/@vite/client' '/sdk/@vite/client';
  sub_filter '/vite-inject-mocker-entry.js' '/sdk/vite-inject-mocker-entry.js';
  sub_filter '"/@id/' '"/sdk/@id/';
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/;  # trailing slash strips /sdk/
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# Storybook/Vite internals under /sdk
location = /sdk/@vite/client {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header ngrok-skip-browser-warning "true";
  proxy_pass http://encast-sdk:6006/@vite/client;
}

location ^~ /sdk/@vite/ {
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_read_timeout 1h;
  set $up_encast_sdk_6006_1 encast-sdk:6006;
  proxy_pass http://$up_encast_sdk_6006_1/@vite/;
}

location ^~ /sdk/@id/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/@id/;
}

location ^~ /sdk/@fs/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_sdk_6006_1 encast-sdk:6006;
  proxy_pass http://$up_encast_sdk_6006_1/@fs/;
}

location ^~ /sdk/node_modules/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_sdk_6006_1 encast-sdk:6006;
  proxy_pass http://$up_encast_sdk_6006_1/node_modules/;
}

# Story index JSONs (serve as JSON to avoid SPA fallback)
location = /sdk/sb-index.json {
  proxy_set_header Host encast-sdk:6006;
  proxy_pass http://encast-sdk:6006/sb-index.json;
  proxy_hide_header Content-Type;
  add_header Content-Type application/json;
}
location = /sdk/index.json {
  proxy_set_header Host encast-sdk:6006;
  proxy_pass http://encast-sdk:6006/index.json;
  proxy_hide_header Content-Type;
  add_header Content-Type application/json;
}

# Fonts under /sdk only (serve with correct content-type)
location ~* ^/sdk/sb-common-assets/(.+)\.woff2$ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $upstream_path /sb-common-assets/$1.woff2;
  proxy_pass http://encast-sdk:6006$upstream_path;
  proxy_hide_header Content-Type;
  add_header Content-Type font/woff2;
}

# Storybook manager/addon bundles (SB9 serves at root; also provide /sdk/* exacts)
location = /sb-manager/runtime.js {
  proxy_set_header Host encast-sdk:6006;
  proxy_pass http://encast-sdk:6006/sb-manager/runtime.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}
location = /sb-addons/common-manager-bundle.js {
  proxy_set_header Host encast-sdk:6006;
  proxy_pass http://encast-sdk:6006/sb-addons/common-manager-bundle.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}
location = /sb-manager/globals-runtime.js {
  proxy_set_header Host encast-sdk:6006;
  proxy_pass http://encast-sdk:6006/sb-manager/globals-runtime.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}

# Exact font assets under /sdk to bypass other handlers
location = /sdk/sb-common-assets/nunito-sans-regular.woff2 {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/sb-common-assets/nunito-sans-regular.woff2;
}
location = /sdk/sb-common-assets/nunito-sans-bold.woff2 {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/sb-common-assets/nunito-sans-bold.woff2;
}
location = /sdk/sb-common-assets/nunito-sans-italic.woff2 {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/sb-common-assets/nunito-sans-italic.woff2;
}
location = /sdk/sb-common-assets/nunito-sans-bold-italic.woff2 {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/sb-common-assets/nunito-sans-bold-italic.woff2;
}

# Same manager assets under /sdk/ path (precise matches to avoid HTML fallback)
location = /sdk/sb-manager/runtime.js {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_pass http://encast-sdk:6006/sb-manager/runtime.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}
location = /sdk/sb-addons/common-manager-bundle.js {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_pass http://encast-sdk:6006/sb-addons/common-manager-bundle.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}
location = /sdk/sb-manager/globals-runtime.js {
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Prefix /sdk;
  proxy_pass http://encast-sdk:6006/sb-manager/globals-runtime.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}

# removed duplicate /sdk/@id/ block (handled above)

## REMOVED duplicate /sdk/sb-common-assets block (see canonical one later in file)

# removed root-scoped dev helper: /vite-inject-mocker-entry.js

# SDK-prefixed vite-inject-mocker-entry.js
location = /sdk/vite-inject-mocker-entry.js {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/vite-inject-mocker-entry.js;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}

# Root-level Storybook/Vite fallbacks (when dev server emits absolute paths)
# removed root /@vite/ (apps must live under /sdk)

# Additional Vite dev server routes (root-scoped)
# removed root /.vite/

# removed root /assets/

# removed root /__vite_ping

# duplicate removed: /sdk/__vite_ping (see canonical earlier)

# removed root /__open-in-editor

# removed root /vite/

# removed root /sb-

# Root UI and iframe (exact matches) — all removed to avoid root exposure

# removed root-capable sb-common-assets regex (enforced /sdk-only above)

# Exact font assets at root (some managers preload these at root)
# removed root font exposures

# removed root index.json exposure

# Optional: quiet 404s for Storybook source fetches
# removed root .storybook exposure

# Optional HMR WS (if not already present)
location ^~ /sdk/storybook-server-channel {
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host encast-sdk:6006;
  proxy_pass http://encast-sdk:6006/storybook-server-channel;
}

# API → Django (preserve /api prefix)
location /api/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  absolute_redirect off;
  proxy_redirect off;
  set $up_encast_api_8000_2 http://encast-api:8000;
  proxy_pass $up_encast_api_8000_2;      # no trailing slash, preserves /api/*
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# Health check endpoint for Django API
location /api/health/ {
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_api_8000_1 http://encast-api:8000;
  proxy_pass $up_encast_api_8000_1;      # preserve /health/*
}

# API static files (strip /api prefix → forward to Django /static)
location ^~ /api/static/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header ngrok-skip-browser-warning "true";
  # Dev CORS headers for static assets
  if ($request_method = 'OPTIONS') {
    add_header 'Access-Control-Allow-Origin' "$http_origin" always;
    add_header 'Vary' 'Origin' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Accept, Content-Type, Authorization' always;
    add_header 'Access-Control-Max-Age' 3600 always;
    return 204;
  }
  add_header 'Access-Control-Allow-Origin' "$http_origin" always;
  add_header 'Vary' 'Origin' always;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_api_8000_3 http://encast-api:8000;
  rewrite ^/api/static/(.*)$ /static/$1 break;
  proxy_pass $up_encast_api_8000_3;      # 🤖 CALLIOPE AUTO-FIX: Added rewrite rule
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# API media files (strip /api prefix → forward to Django /media)
location ^~ /api/media/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header ngrok-skip-browser-warning "true";
  # Dev CORS headers for media assets
  if ($request_method = 'OPTIONS') {
    add_header 'Access-Control-Allow-Origin' "$http_origin" always;
    add_header 'Vary' 'Origin' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Accept, Content-Type, Authorization' always;
    add_header 'Access-Control-Max-Age' 3600 always;
    return 204;
  }
  add_header 'Access-Control-Allow-Origin' "$http_origin" always;
  add_header 'Vary' 'Origin' always;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_api_8000_4 http://encast-api:8000;
  rewrite ^/api/media/(.*)$ /media/$1 break;
  proxy_pass $up_encast_api_8000_4;      # 🤖 CALLIOPE AUTO-FIX: Added rewrite rule
}

# Impact (CRA dev server, HMR/WS)
location = /impact { rewrite ^ /impact/ last; }
location = /impact/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  # Serve the index for base route from upstream root
  set $up_encast_impact_3000_5 http://encast-impact:3000/;
  proxy_pass $up_encast_impact_3000_5;
}
location /impact/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header X-Forwarded-Prefix /impact;
  # Add headers to help React dev server understand the context
  proxy_set_header X-Original-URI $request_uri;
  proxy_set_header X-Forwarded-URI $request_uri;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_impact_3000_6 http://encast-impact:3000;
  proxy_pass $up_encast_impact_3000_6;    # preserve /impact/ for app routes
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# Impact dev server assets & HMR endpoints at root (index uses absolute paths)
# Route these to the Impact dev server so /impact/ works end-to-end
location = /bundle.js {
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_impact_3000_bundle http://encast-impact:3000/bundle.js;
  proxy_pass $up_encast_impact_3000_bundle;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}
# Enhanced bundle.js route - 🤖 CALLIOPE AUTO-FIX: Added content-type forcing
location = /static/js/bundle.js {
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_impact_3000_static_bundle http://encast-impact:3000/static/js/bundle.js;
  proxy_pass $up_encast_impact_3000_static_bundle;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;  # 🤖 FORCES CORRECT CONTENT-TYPE
}
location ^~ /static/ {
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  # 🤖 CALLIOPE FIX: Remove trailing slash from variable to preserve full request path
  set $up_encast_impact_3000_static http://encast-impact:3000;
  proxy_pass $up_encast_impact_3000_static;
}
# Handle bundle.js requested through /impact path (React may use relative paths)
location = /impact/bundle.js {
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_impact_3000_impact_bundle http://encast-impact:3000/bundle.js;
  proxy_pass $up_encast_impact_3000_impact_bundle;
  proxy_hide_header Content-Type;
  add_header Content-Type application/javascript;
}
location ^~ /impact/static/ {
  proxy_set_header Host encast-impact:3000;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  # Rewrite /impact/static/... → /static/... before proxying to preserve path with variable-based proxy_pass
  rewrite ^/impact/static/(.*)$ /static/$1 break;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_impact_3000_static http://encast-impact:3000;
  proxy_pass $up_encast_impact_3000_static;
}
location ^~ /sockjs-node {
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host encast-impact:3000;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_impact_3000_7 http://encast-impact:3000/sockjs-node;
  proxy_pass $up_encast_impact_3000_7;
}
location ^~ /impact/asset-manifest.json {
  proxy_set_header Host encast-impact:3000;
  rewrite ^/impact/asset-manifest\.json$ /asset-manifest.json break;
  set $up_encast_impact_3000_1 http://encast-impact:3000;
  proxy_pass $up_encast_impact_3000_1;
}
location ^~ /impact/favicon.ico {
  proxy_set_header Host encast-impact:3000;
  rewrite ^/impact/favicon\.ico$ /favicon.ico break;
  set $up_encast_impact_3000_2 http://encast-impact:3000;
  proxy_pass $up_encast_impact_3000_2;
}

# Inspire (React dev server) - strip /inspire/ prefix
location = /inspire { rewrite ^ /inspire/ last; }
location ^~ /inspire/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  # Defer name resolution so nginx reload doesn't fail when service is down
  set $inspire_upstream encast-inspire:3001;
  proxy_pass http://$inspire_upstream/;      # trailing slash strips /inspire/
  proxy_read_timeout 300;
  proxy_send_timeout 300;
}

# Storybook WS is accessed under /sdk/storybook-server-channel and handled by the /sdk/ block above.
# Some clients use an absolute root WS path without /sdk – support that too
# removed root storybook-server-channel exposure

# Admin - preserve /admin/ prefix
location ^~ /admin/ {
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_api_8000_38 http://encast-api:8000;
  proxy_pass $up_encast_api_8000_38;      # preserve /admin/*
}

# Payment - strip /payment/ prefix
location ^~ /payment/ {
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header ngrok-skip-browser-warning "true";
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  # Defer name resolution so nginx reload doesn't fail when service is down
  set $payment_upstream encast-payment:5454;
  proxy_pass http://$payment_upstream/; # trailing slash strips /payment/
}
location = /_next { return 204; }

location = /_next/ { return 204; }
location ^~ /sdk/sb-manager/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Prefix /sdk;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/sb-manager/;
}
location ^~ /sdk/sb-addons/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Prefix /sdk;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://encast-sdk:6006/sb-addons/;
}
location ^~ /sdk/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host encast-sdk:6006;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $up_encast_sdk_6006_1 encast-sdk:6006;
  proxy_pass http://$up_encast_sdk_6006_1/_next/;
}
